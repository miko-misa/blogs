name: Render blogs to portfolio

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout blogs
        uses: actions/checkout@v4

      - name: Download typmark-cli
        run: |
          python3 - <<'PY'
          import json
          import os
          import shutil
          import tarfile
          import urllib.request

          api_url = "https://api.github.com/repos/miko-misa/typmark/releases/latest"
          with urllib.request.urlopen(api_url) as resp:
            data = json.load(resp)

          asset = None
          for item in data.get("assets", []):
            name = item.get("name", "")
            if name.endswith("x86_64-unknown-linux-gnu.tar.gz"):
              asset = item
              break

          if not asset:
            raise SystemExit("typmark-cli release asset not found")

          url = asset["browser_download_url"]
          archive_path = "typmark-cli.tar.gz"
          urllib.request.urlretrieve(url, archive_path)

          extract_dir = "typmark-cli-bin"
          os.makedirs(extract_dir, exist_ok=True)
          with tarfile.open(archive_path, "r:gz") as tar:
            tar.extractall(extract_dir)

          binary_path = None
          for root, _, files in os.walk(extract_dir):
            if "typmark-cli" in files:
              binary_path = os.path.join(root, "typmark-cli")
              break

          if not binary_path:
            raise SystemExit("typmark-cli binary not found in archive")

          shutil.copy2(binary_path, "./typmark-cli")
          os.chmod("./typmark-cli", 0o755)
          PY

      - name: Render .tmd to HTML
        run: |
          rm -rf site
          mkdir -p site/blogs-content site/blogs/assets

          python3 - <<'PY'
          import json
          import subprocess
          from pathlib import Path

          root = Path(".").resolve()

          def is_ignored(path: Path) -> bool:
            parts = set(path.parts)
            return ".git" in parts or ".github" in parts or "site" in parts

          def parse_articles_yaml(path: Path):
            lines = path.read_text(encoding="utf-8").splitlines()
            articles = []
            current = None
            in_articles = False
            for raw in lines:
              line = raw.rstrip()
              if not line or line.lstrip().startswith("#"):
                continue
              if line.startswith("articles:"):
                in_articles = True
                continue
              if not in_articles:
                continue
              stripped = line.lstrip()
              if stripped.startswith("-"):
                if current:
                  articles.append(current)
                current = {}
                remainder = stripped[1:].strip()
                if remainder:
                  if ":" not in remainder:
                    raise SystemExit(f"Invalid articles.yml entry: {path}")
                  key, value = remainder.split(":", 1)
                  current[key.strip()] = value.strip().strip('"')
                continue
              if current is None:
                raise SystemExit(f"Invalid articles.yml structure: {path}")
              if ":" not in stripped:
                raise SystemExit(f"Invalid articles.yml entry: {path}")
              key, value = stripped.split(":", 1)
              current[key.strip()] = value.strip().strip('"')
            if current:
              articles.append(current)
            return articles

          yaml_paths = [
            p
            for p in root.rglob("articles.yml")
            if not is_ignored(p)
          ]

          if not yaml_paths:
            raise SystemExit("No articles.yml found")

          index = {"folders": {}}
          folder_keys = []

          for yaml_path in yaml_paths:
            folder = yaml_path.parent
            rel_folder = folder.relative_to(root)
            folder_key = "" if str(rel_folder) == "." else rel_folder.as_posix()
            folder_keys.append(folder_key)

            pages = []
            for node in parse_articles_yaml(yaml_path):
              file_name = node.get("file")
              slug = node.get("slug")
              title = node.get("title") or slug or file_name

              if not file_name or not slug:
                raise SystemExit(
                  f"Invalid article entry in {yaml_path}: file and slug are required"
                )

              tmd_path = folder / file_name
              if not tmd_path.exists():
                raise SystemExit(f"Missing tmd file: {tmd_path}")

              out_rel = f"{folder_key}/{slug}" if folder_key else slug
              out_path = Path("site/blogs-content") / f"{out_rel}.html"
              out_path.parent.mkdir(parents=True, exist_ok=True)

              html = subprocess.check_output(
                [
                  "./typmark-cli",
                  "--render",
                  "--theme",
                  "dark",
                  str(tmd_path),
                ]
              )
              out_path.write_bytes(html)

              pages.append({"slug": slug, "title": title, "path": out_rel})

            index["folders"][folder_key] = {"pages": pages, "folders": []}

          folder_keys = sorted(set(folder_keys))

          for folder_key in folder_keys:
            prefix = f"{folder_key}/" if folder_key else ""
            children = []
            for child in folder_keys:
              if child == folder_key:
                continue
              if not child.startswith(prefix):
                continue
              rest = child[len(prefix):]
              if "/" in rest:
                continue
              children.append({"name": rest, "path": child})

            index["folders"][folder_key]["folders"] = sorted(
              children, key=lambda item: item["name"]
            )
            index["folders"][folder_key]["pages"] = sorted(
              index["folders"][folder_key]["pages"],
              key=lambda item: item["title"].lower(),
            )

          Path("site/blogs-index.json").write_text(
            json.dumps(index, ensure_ascii=False, indent=2),
            encoding="utf-8",
          )
          PY

          if [ -d assets ]; then
            rsync -a assets/ site/blogs/assets/
          fi

      - name: Checkout portfolio
        uses: actions/checkout@v4
        with:
          repository: miko-misa/portfolio
          token: ${{ secrets.PORTFOLIO_PUSH_TOKEN }}
          path: portfolio

      - name: Publish to portfolio
        run: |
          rm -rf portfolio/public/blogs
          rm -rf portfolio/public/blogs-content
          rm -rf portfolio/public/blogs/assets

          mkdir -p portfolio/public/blogs-content portfolio/public/blogs/assets
          rsync -a site/blogs-content/ portfolio/public/blogs-content/
          rsync -a site/blogs/assets/ portfolio/public/blogs/assets/
          cp site/blogs-index.json portfolio/public/blogs-index.json

          cd portfolio
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/blogs-content public/blogs/assets public/blogs-index.json
          git commit -m "Update blogs from blogs repo"
          git push
